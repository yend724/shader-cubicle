import { LearningLayout } from '@/components/layout/LearningLayout';
import { ShaderCodeMirrorWithCanvas } from "@/components/ui/ShaderCodeMirrorWithCanvas";
import { vertexShader, fragmentShader } from "./shaders.ts"

export const meta = {
  title: "Shaderを描くための準備",
  published: "2022-10-26",
  author: "YEND",
  tag: ["vetexShader", "fragmentShader"]
}
export default ({ children }) => (
  <LearningLayout meta={meta}>{children}</LearningLayout>
);


本記事ではShaderを描くための準備をする。

Shaderを描くにはいくつか選択肢ががあるが、本サイトでは基本的に[React Three Fiber](https://docs.pmnd.rs/react-three-fiber/getting-started/introduction)を使用する。ざっくり以下のようなコードを書いている。

```tsx
import { Canvas } from '@react-three/fiber';

// 視野角からCameraのZ軸の距離を計算
// CanvasのサイズにPlaneオブジェクトを合わせる
const calcDistFromFov = (fov: number): number => {
  const fovRad = (fov / 2) * (Math.PI / 180);
  return 2 / 2 / Math.tan(fovRad);
};

const App = () => {
return (
  <Canvas
    camera={{
      fov: 60,
      near: 0.1,
      far: 1000,
      position: [0, 0, calcDistFromFov(60)],
    }}
  >
    <mesh>
      <planeGeometry args={[2, 2, 64, 64]} />
      {/* vertexShader と fragmetSahader　を渡す */}
      <shaderMaterial
        vertexShader={`...`}
        fragmentShader={`...`}
      />
    </mesh>
  </Canvas>
)}
```

マテリアルとジオメトリについては以下のドキュメントを参照。

- [PlaneGeometry](https://threejs.org/docs/index.html?q=plane#api/en/geometries/PlaneGeometry)
- [ShaderMaterial](https://threejs.org/docs/index.html?q=shader#api/en/materials/ShaderMaterial)

## ハローワールドしてみる

とりあえずハローワールドということで最初のシェーダーを書いてみよう。一旦細かいことは置いておいて頂点シェーダー（Vertex Shader）とフラグメントシェーダー（Fragment Shader）を次のように記述してみる。

```glsl[data-label="vertexShader"]
void main () {
  gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.0);
}
```

```glsl[data-label="fragmentShader"]
void main () {
  gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
}
```

実行結果は以下になる。

<ShaderCodeMirrorWithCanvas
  material={{
    vertexShader: vertexShader,
    fragmentShader: fragmentShader,
  }}
/>

黒色のCanvasが表示された。これが本サイトにおける最初のシェーダーコードである。

`gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);`の部分を`gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);`に変更してみる。Canvasが赤色に変化すれば、本記事における準備は完了である。

## セグメント

ちなみに`PlaneGeometry`に渡している値を確認するとわかるが、このジオメトリは縦横それぞれに64分割されている。`wireframe`オブションを`true`にしてみるとわかりやすいので、以下で確認する。

<ShaderCodeMirrorWithCanvas
  material={{
    vertexShader: vertexShader,
    fragmentShader: fragmentShader,
    wireframe: true
  }}
/>

ワイヤーフレーム状態にすることセグメントの数が確認できた。